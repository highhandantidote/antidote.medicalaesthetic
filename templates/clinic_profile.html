{% extends "base.html" %}

{% block title %}{{ clinic.name }} - {{ clinic.city }}{% endblock %}

{% block head %}
<meta name="csrf-token" content="{{ csrf_token() }}">
<!-- Leaflet CSS for OpenStreetMap -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
      crossorigin=""/>
{% endblock %}

{% block content %}
<div class="container my-4">
    <!-- Breadcrumb Navigation -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('web.index') }}">Home</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('clinic.all_clinics') }}">Clinics</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ clinic.name }}</li>
        </ol>
    </nav>

    <!-- Promotional Banner -->
    <div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
        <i class="fas fa-gift me-2"></i>
        <strong>Special Offer:</strong> Get 30% off on all procedures this month! Limited time only.
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <!-- Clinic Header -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="h2 mb-2">{{ clinic.name }}</h1>
                    <div class="text-warning mb-2">
                        {% if clinic.google_rating %}
                            {% set rating = clinic.google_rating %}
                            {% for i in range(1, 6) %}
                                {% if i <= rating %}
                                    <i class="fas fa-star"></i>
                                {% elif i - 0.5 <= rating %}
                                    <i class="fas fa-star-half-alt"></i>
                                {% else %}
                                    <i class="far fa-star"></i>
                                {% endif %}
                            {% endfor %}
                            <span class="ms-2 text-muted">{{ "%.1f"|format(rating) }} ({{ clinic.google_review_count }} Google reviews)</span>
                        {% else %}
                            <i class="fas fa-star text-muted"></i>
                            <i class="fas fa-star text-muted"></i>
                            <i class="fas fa-star text-muted"></i>
                            <i class="fas fa-star text-muted"></i>
                            <i class="fas fa-star text-muted"></i>
                            <span class="ms-2 text-muted">No reviews yet</span>
                        {% endif %}
                    </div>
                    <p class="text-muted mb-2">
                        <i class="fas fa-map-marker-alt me-2"></i>{{ clinic.area or 'Bopal Rd, near Big Bazaar, Bopal' }}, {{ clinic.city }}, {{ clinic.state }}
                    </p>
                    <p class="text-muted mb-0">
                        <i class="fas fa-clock me-2"></i>Today: 9:00 AM - 9:00 PM 
                        <span class="text-success ms-2">Open now</span>
                    </p>
                    <a href="#" class="text-primary text-decoration-none small">All Reviews</a>
                </div>
                <div class="col-md-4 text-md-end">
                    <button class="btn btn-primary btn-lg mb-2 w-100" data-bs-toggle="modal" data-bs-target="#consultationModal">
                        <i class="fas fa-calendar-plus me-2"></i>Book Consultation
                    </button>
                    <button class="btn btn-outline-primary btn-lg w-100">
                        <i class="fas fa-phone me-2"></i>{{ clinic.contact_number or '+91 99999 44570' }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Clinic Highlights -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Clinic Highlights</h5>
        </div>
        <div class="card-body">
            <div class="row text-center">
                <div class="col-md-3 col-6 mb-3">
                    <div class="p-3">
                        <i class="fas fa-user-md fa-2x text-primary mb-2"></i>
                        <div class="small text-muted">Post-procedure care</div>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="p-3">
                        <i class="fas fa-award fa-2x text-primary mb-2"></i>
                        <div class="small text-muted">Real names and qualifications listed</div>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="p-3">
                        <i class="fas fa-video fa-2x text-primary mb-2"></i>
                        <div class="small text-muted">CCTV camera in the operating room</div>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="p-3">
                        <i class="fas fa-clock fa-2x text-primary mb-2"></i>
                        <div class="small text-muted">Evening hours</div>
                    </div>
                </div>
            </div>
            <div class="row text-center">
                <div class="col-md-3 col-6 mb-3">
                    <div class="p-3">
                        <i class="fas fa-bed fa-2x text-primary mb-2"></i>
                        <div class="small text-muted">Recovery room</div>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="p-3">
                        <i class="fas fa-shield-alt fa-2x text-primary mb-2"></i>
                        <div class="small text-muted">Non surgical focus</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Most Popular Procedures -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Most popular procedures</h5>
        </div>
        <div class="card-body">
            <div class="procedure-item d-flex justify-content-between align-items-center py-3 border-bottom">
                <div class="d-flex align-items-center">
                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                        <i class="fas fa-syringe"></i>
                    </div>
                    <div>
                        <div class="fw-medium">Lip fillers</div>
                        <div class="text-muted small">‚Çπ8,000 - ‚Çπ25,000</div>
                    </div>
                </div>
            </div>
            <div class="procedure-item d-flex justify-content-between align-items-center py-3 border-bottom">
                <div class="d-flex align-items-center">
                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                        <i class="fas fa-eye"></i>
                    </div>
                    <div>
                        <div class="fw-medium">Lip corner filler</div>
                        <div class="text-muted small">‚Çπ15,000 - ‚Çπ28,000</div>
                    </div>
                </div>
            </div>
            <div class="procedure-item d-flex justify-content-between align-items-center py-3 border-bottom">
                <div class="d-flex align-items-center">
                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>
                        <div class="fw-medium">Lip corner botox</div>
                        <div class="text-muted small">‚Çπ8,000 - ‚Çπ25,000</div>
                    </div>
                </div>
            </div>
            <div class="procedure-item d-flex justify-content-between align-items-center py-3 border-bottom">
                <div class="d-flex align-items-center">
                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                        <i class="fas fa-face-smile"></i>
                    </div>
                    <div>
                        <div class="fw-medium">Chin filler</div>
                        <div class="text-muted small">‚Çπ18,000 - ‚Çπ35,000</div>
                    </div>
                </div>
            </div>
            <div class="procedure-item d-flex justify-content-between align-items-center py-3">
                <div class="d-flex align-items-center">
                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                        <i class="fas fa-magic"></i>
                    </div>
                    <div>
                        <div class="fw-medium">Jawline slimming botox</div>
                        <div class="text-muted small">‚Çπ25,000 - ‚Çπ45,000</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Real Feedback From Users -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Real feedback from users</h5>
        </div>
        <div class="card-body">
            <div class="row text-center">
                <div class="col-md-3 col-6 mb-3">
                    <div class="p-3">
                        <div class="h2 text-primary mb-1">94%</div>
                        <div class="small text-muted">Price matched what was listed for chosen plan or Surgery</div>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="p-3">
                        <div class="h2 text-primary mb-1">87%</div>
                        <div class="small text-muted">Waited less than 15 minutes for their appointment compared</div>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="p-3">
                        <div class="h2 text-primary mb-1">96%</div>
                        <div class="small text-muted">Staff was welcoming & caring friendly and professional service</div>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="p-3">
                        <div class="h2 text-primary mb-1">91%</div>
                        <div class="small text-muted">Consulted only on my preferences for cosmetic or chemical procedures</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Our Specialties -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Our specialties</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4 col-sm-6 mb-2">
                    <span class="badge bg-light text-dark p-2 w-100">Jaw Surgery</span>
                </div>
                <div class="col-md-4 col-sm-6 mb-2">
                    <span class="badge bg-light text-dark p-2 w-100">Filler</span>
                </div>
                <div class="col-md-4 col-sm-6 mb-2">
                    <span class="badge bg-light text-dark p-2 w-100">Botox</span>
                </div>
                <div class="col-md-4 col-sm-6 mb-2">
                    <span class="badge bg-light text-dark p-2 w-100">Rhinoplasty</span>
                </div>
                <div class="col-md-4 col-sm-6 mb-2">
                    <span class="badge bg-light text-dark p-2 w-100">Lip enhancement</span>
                </div>
                <div class="col-md-4 col-sm-6 mb-2">
                    <span class="badge bg-light text-dark p-2 w-100">Dermal contouring</span>
                </div>
                <div class="col-md-4 col-sm-6 mb-2">
                    <span class="badge bg-light text-dark p-2 w-100">Facial rejuvenation</span>
                </div>
                <div class="col-md-4 col-sm-6 mb-2">
                    <span class="badge bg-light text-dark p-2 w-100">Body contouring</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Treatment Packages -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Treatment Packages</h5>
        </div>
        <div class="card-body text-center">
            <p class="text-muted mb-3">View comprehensive treatment packages with detailed pricing, before/after photos, procedure information, and transparent billing.</p>
            <button class="btn btn-primary">View All Treatment Packages</button>
            <div class="text-muted small mt-2">115 detailed packages available</div>
        </div>
    </div>

    <!-- Our Doctors -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Our doctors</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-start mb-3">
                                <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3" style="width: 60px; height: 60px;">
                                    <i class="fas fa-user-md fa-lg"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">Dr. Rajesh Kumar</h6>
                                    <div class="text-muted small mb-1">Lead Cosmetic Surgeon</div>
                                    <div class="text-muted small">15+ Years Experience</div>
                                </div>
                            </div>
                            <div class="small text-muted">
                                <div class="mb-1">‚Ä¢ Hair perfecting procedures</div>
                                <div class="mb-1">‚Ä¢ Lip fillers</div>
                                <div class="mb-1">‚Ä¢ Skin treatments</div>
                                <div class="mb-1">‚Ä¢ Anti-aging solutions</div>
                                <div class="mb-1">‚Ä¢ Filler rejuvenation</div>
                                <div class="mb-1">‚Ä¢ Chin augmentation</div>
                                <div class="mb-1">‚Ä¢ Comprehensive facial care</div>
                            </div>
                            <button class="btn btn-outline-primary btn-sm mt-3">See all Doctors</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-start mb-3">
                                <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3" style="width: 60px; height: 60px;">
                                    <i class="fas fa-user-md fa-lg"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">Dr. Priya Sharma</h6>
                                    <div class="text-muted small mb-1">Aesthetic Specialist</div>
                                    <div class="text-muted small">10+ Years Experience</div>
                                </div>
                            </div>
                            <div class="small text-muted">
                                <div class="mb-1">‚Ä¢ Hair perfecting procedures</div>
                                <div class="mb-1">‚Ä¢ Lip fillers</div>
                                <div class="mb-1">‚Ä¢ Skin treatments</div>
                                <div class="mb-1">‚Ä¢ Anti-aging solutions</div>
                                <div class="mb-1">‚Ä¢ Non surgical lifting</div>
                                <div class="mb-1">‚Ä¢ Dermal augmentation</div>
                                <div class="mb-1">‚Ä¢ Advanced cosmetic care</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- What Our Patients Say - Authentic Google Reviews -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">What Our Patients Say</h5>
            <div class="d-flex align-items-center">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c1/Google_%22G%22_logo.svg/24px-Google_%22G%22_logo.svg.png" alt="Google" class="me-1" style="width: 16px;">
                <small class="text-muted">Google Reviews</small>
            </div>
        </div>
        <div class="card-body">
            {% if clinic.google_rating and clinic.google_review_count %}
            <!-- Overall Rating Display -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="d-flex align-items-center mb-2">
                        <span class="display-6 fw-bold text-primary me-3">{{ "%.1f"|format(clinic.google_rating) }}</span>
                        <div>
                            <div class="text-warning mb-1">
                                {% for i in range(1, 6) %}
                                    {% if i <= clinic.google_rating %}
                                        <i class="fas fa-star"></i>
                                    {% elif i - 0.5 <= clinic.google_rating %}
                                        <i class="fas fa-star-half-alt"></i>
                                    {% else %}
                                        <i class="far fa-star"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <div class="text-muted small">Based on {{ clinic.google_review_count }} Google reviews</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    {% if clinic.last_review_sync %}
                    <div class="text-end">
                        <small class="text-muted">
                            <i class="fas fa-sync me-1"></i>Last updated: {{ clinic.last_review_sync.strftime('%B %d, %Y') }}
                        </small>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Google Reviews Display -->
            <div id="googleReviewsDisplay">
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading reviews...</span>
                    </div>
                    <div class="mt-2 text-muted">Loading authentic Google reviews...</div>
                </div>
            </div>

            <!-- Simple Review Loading Script -->
            <script>
                console.log('SIMPLE REVIEW LOADER: Starting...');
                
                function loadSimpleReviews() {
                    const clinicId = {{ clinic.id }};
                    console.log('SIMPLE: Loading reviews for clinic', clinicId);
                    
                    var container = document.getElementById('googleReviewsDisplay');
                    if (!container) {
                        console.error('SIMPLE: Container not found');
                        return;
                    }
                    
                    var xhr = new XMLHttpRequest();
                    xhr.open('GET', '/api/clinic/' + clinicId + '/google-reviews?t=' + Date.now(), true);
                    xhr.onreadystatechange = function() {
                        if (xhr.readyState === 4) {
                            console.log('SIMPLE: XHR status:', xhr.status);
                            if (xhr.status === 200) {
                                try {
                                    var data = JSON.parse(xhr.responseText);
                                    console.log('SIMPLE: Data received:', data);
                                    
                                    if (data.reviews && data.reviews.length > 0) {
                                        var reviewsHtml = '';
                                        for (var i = 0; i < Math.min(3, data.reviews.length); i++) {
                                            var review = data.reviews[i];
                                            console.log('SIMPLE: Processing review:', review.author_name, 'Rating:', review.rating);
                                            
                                            var stars = '';
                                            var rating = parseFloat(review.rating);
                                            for (var j = 1; j <= 5; j++) {
                                                if (j <= rating) {
                                                    stars += '<i class="fas fa-star text-warning"></i>';
                                                } else {
                                                    stars += '<i class="far fa-star text-warning"></i>';
                                                }
                                            }
                                            
                                            // Create profile image with Google-style fallback
                                            var firstLetter = review.author_name ? review.author_name.charAt(0).toUpperCase() : 'U';
                                            var profileImage = review.profile_photo_url 
                                                ? '<img src="' + review.profile_photo_url + '" alt="' + review.author_name + '" class="rounded-circle me-3" style="width: 48px; height: 48px; object-fit: cover;" onerror="this.style.display=\'none\'; this.nextElementSibling.style.display=\'flex\';">' +
                                                  '<div class="rounded-circle me-3 d-flex align-items-center justify-content-center text-white fw-bold" style="width: 48px; height: 48px; background-color: #4285f4; display: none;">' + firstLetter + '</div>'
                                                : '<div class="rounded-circle me-3 d-flex align-items-center justify-content-center text-white fw-bold" style="width: 48px; height: 48px; background-color: #4285f4;">' + firstLetter + '</div>';
                                            
                                            var reviewText = review.text.length > 200 
                                                ? review.text.substring(0, 200) + '...'
                                                : review.text;
                                            
                                            reviewsHtml += '<div class="review-item border-bottom pb-3 mb-3">' +
                                                '<div class="d-flex align-items-start mb-2">' +
                                                profileImage +
                                                '<div class="flex-grow-1">' +
                                                '<div class="d-flex align-items-center mb-2">' +
                                                '<h6 class="mb-0 me-2">' + review.author_name + '</h6>' +
                                                '<div class="d-flex align-items-center">' + stars + '</div>' +
                                                '</div>' +
                                                '<p class="mb-1 text-muted small">' + reviewText + '</p>' +
                                                '<small class="text-muted">' + (review.relative_time || 'Recently') + '</small>' +
                                                '</div></div></div>';
                                        }
                                        
                                        container.innerHTML = reviewsHtml;
                                        console.log('SIMPLE: Successfully rendered', data.reviews.length, 'reviews');
                                    } else {
                                        container.innerHTML = '<div class="text-center py-4"><div class="text-muted"><i class="fab fa-google fa-2x mb-3"></i><p>No Google reviews available yet.</p></div></div>';
                                    }
                                } catch (e) {
                                    console.error('SIMPLE: JSON parse error:', e);
                                    container.innerHTML = '<div class="text-center py-4"><div class="text-muted"><i class="fab fa-google fa-2x mb-3"></i><p>Error loading reviews.</p></div></div>';
                                }
                            } else {
                                console.error('SIMPLE: Request failed with status:', xhr.status);
                                container.innerHTML = '<div class="text-center py-4"><div class="text-muted"><i class="fab fa-google fa-2x mb-3"></i><p>Unable to load reviews.</p></div></div>';
                            }
                        }
                    };
                    xhr.send();
                }
                
                // Execute when ready
                console.log('SIMPLE: Document ready state:', document.readyState);
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', function() {
                        console.log('SIMPLE: DOM loaded, starting reviews...');
                        setTimeout(loadSimpleReviews, 500);
                    });
                } else {
                    console.log('SIMPLE: Document already loaded, starting reviews...');
                    setTimeout(loadSimpleReviews, 100);
                }
            </script>
            
            <!-- Debug info -->
            <div id="debugInfo" style="display: none;">
                <small class="text-muted">Debug: Container exists, checking API...</small>
            </div>

            <!-- View All Reviews Link -->
            <div class="text-center mt-3">
                <a href="https://www.google.com/search?q={{ clinic.name|urlencode }}+{{ clinic.city|urlencode }}+reviews" 
                   target="_blank" class="btn btn-outline-primary btn-sm">
                    <i class="fab fa-google me-1"></i>View All Google Reviews
                </a>
            </div>
        </div>
    </div>

    <!-- Clinic Location Map -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">üìç {{ clinic.name }} Location</h5>
        </div>
        <div class="card-body">
            <div class="map-container" id="clinic-map" style="height: 300px; border-radius: 10px; overflow: hidden; border: 1px solid #ddd;">
                <!-- OpenStreetMap will be loaded here -->
                <div id="map" style="height: 100%; width: 100%;">
                    <div id="map-loading" class="d-flex align-items-center justify-content-center h-100">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading map...</span>
                            </div>
                            <p class="text-muted mt-2">Loading map...</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-3 text-center">
                <p class="text-muted mb-1">{{ clinic.name }}</p>
                <p class="small text-muted" id="clinic-address">{{ clinic.address or 'Address not available' }}</p>
                <button class="btn btn-outline-primary btn-sm" onclick="openDirections()" id="directions-btn" style="display: none;">
                    <i class="fas fa-directions"></i> Get Directions
                </button>
            </div>
        </div>
    </div>

</div>

<!-- CTA Footer - Chat and Call Options -->
<div class="fixed-bottom bg-white border-top p-3 d-md-none">
    <div class="container">
        <div class="row">
            <div class="col-6">
                <button class="btn btn-success w-100" onclick="instantContactClinic({{ clinic.id }}, 'whatsapp')" id="clinic-whatsapp-btn">
                    <i class="fab fa-whatsapp me-2"></i>
                    <span class="btn-text">Chat</span>
                </button>
            </div>
            <div class="col-6">
                <button class="btn btn-primary w-100" onclick="instantContactClinic({{ clinic.id }}, 'call')" id="clinic-call-btn">
                    <i class="fas fa-phone me-2"></i>
                    <span class="btn-text">Call</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Consultation Booking Modal -->
<div class="modal fade" id="consultationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Book Consultation at {{ clinic.name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('clinic.contact_clinic', clinic_id=clinic.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Full Name *</label>
                        <input type="text" class="form-control" name="patient_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone Number *</label>
                        <input type="tel" class="form-control" name="patient_phone" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" name="patient_email">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Procedure of Interest</label>
                        <select class="form-select" name="procedure_interest">
                            <option value="">Select a procedure</option>
                            <option value="Lip fillers">Lip fillers</option>
                            <option value="Lip corner filler">Lip corner filler</option>
                            <option value="Botox">Botox</option>
                            <option value="Chin filler">Chin filler</option>
                            <option value="Jawline slimming botox">Jawline slimming botox</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Preferred Date</label>
                        <input type="date" class="form-control" name="preferred_date">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Message</label>
                        <textarea class="form-control" name="message" rows="3" placeholder="Tell us about your requirements..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Book Consultation</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Leaflet JavaScript for OpenStreetMap -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
        crossorigin=""></script>

<script>
try {
    console.log('CLINIC PROFILE SCRIPT STARTING...');
    console.log('Current page URL:', window.location.href);
    console.log('Document ready state:', document.readyState);
} catch (error) {
    console.error('Script initialization error:', error);
}

function toggleFavorite(clinicId) {
    console.log('Toggle favorite for clinic:', clinicId);
}

function shareClinic() {
    if (navigator.share) {
        navigator.share({
            title: '{{ clinic.name }}',
            text: 'Check out {{ clinic.name }} in {{ clinic.city }}',
            url: window.location.href
        });
    } else {
        navigator.clipboard.writeText(window.location.href).then(() => {
            alert('Clinic link copied to clipboard!');
        });
    }
}

function renderStars(rating) {
    let starsHtml = '';
    const numRating = parseFloat(rating);
    console.log('Rendering stars for rating:', numRating);
    
    for (let i = 1; i <= 5; i++) {
        if (i <= numRating) {
            starsHtml += '<i class="fas fa-star text-warning"></i>';
        } else if (i - 0.5 <= numRating) {
            starsHtml += '<i class="fas fa-star-half-alt text-warning"></i>';
        } else {
            starsHtml += '<i class="far fa-star text-warning"></i>';
        }
    }
    return starsHtml;
}

function loadGoogleReviews() {
    console.log('REVIEWS: Starting loadGoogleReviews function...');
    const clinicId = parseInt('{{ clinic.id }}');
    const reviewsContainer = document.getElementById('googleReviewsDisplay');
    
    console.log('REVIEWS: Clinic ID:', clinicId);
    console.log('REVIEWS: Container element:', reviewsContainer);
    
    if (!reviewsContainer) {
        console.error('REVIEWS: Container not found');
        return;
    }
    
    console.log('REVIEWS: Loading reviews for clinic', clinicId);
    
    fetch('/api/clinic/' + clinicId + '/google-reviews?t=' + Date.now())
        .then(response => {
            console.log('REVIEWS: API response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('REVIEWS: Reviews data received:', data);
            if (data.reviews && data.reviews.length > 0) {
                let reviewsHtml = '';
                data.reviews.slice(0, 3).forEach(function(review) {
                    console.log('REVIEWS: Processing review from', review.author_name, 'with rating', review.rating);
                    
                    // Create profile image with Google-style fallback
                    const firstLetter = review.author_name ? review.author_name.charAt(0).toUpperCase() : 'U';
                    const profileImage = review.profile_photo_url 
                        ? '<img src="' + review.profile_photo_url + '" alt="' + review.author_name + '" class="rounded-circle me-3" style="width: 48px; height: 48px; object-fit: cover;" onerror="this.style.display=\'none\'; this.nextElementSibling.style.display=\'flex\';">' +
                          '<div class="rounded-circle me-3 d-flex align-items-center justify-content-center text-white fw-bold" style="width: 48px; height: 48px; background-color: #4285f4; display: none;">' + firstLetter + '</div>'
                        : '<div class="rounded-circle me-3 d-flex align-items-center justify-content-center text-white fw-bold" style="width: 48px; height: 48px; background-color: #4285f4;">' + firstLetter + '</div>';
                    
                    const reviewText = review.text.length > 200 
                        ? '<span class="review-text-short">' + review.text.substring(0, 200) + '...</span><span class="review-text-full" style="display: none;">' + review.text + '</span><a href="#" class="text-primary small read-more-btn" onclick="toggleReviewText(this, event)">Read more</a>'
                        : review.text;
                    
                    console.log('Processing review:', review.author_name, 'Rating:', review.rating, 'Type:', typeof review.rating);
                    
                    reviewsHtml += '<div class="review-item border-bottom pb-3 mb-3">' +
                        '<div class="d-flex align-items-start mb-2">' +
                        profileImage +
                        '<div class="flex-grow-1">' +
                        '<div class="d-flex align-items-center mb-2">' +
                        '<h6 class="mb-0 me-2">' + review.author_name + '</h6>' +
                        '<div class="d-flex align-items-center">' + renderStars(review.rating) + '</div>' +
                        '</div>' +
                        '<p class="mb-1 text-muted small">' + reviewText + '</p>' +
                        '<small class="text-muted">' + (review.relative_time || new Date(review.time).toLocaleDateString()) + '</small>' +
                        '</div></div></div>';
                });
                
                reviewsContainer.innerHTML = reviewsHtml;
                console.log('REVIEWS: Successfully rendered', data.reviews.length, 'reviews');
            } else {
                reviewsContainer.innerHTML = '<div class="text-center py-4"><div class="text-muted"><i class="fab fa-google fa-2x mb-3"></i><p>No Google reviews available yet.</p><small>Reviews will appear here once the clinic receives them on Google.</small></div></div>';
            }
        })
        .catch(error => {
            console.error('REVIEWS: Error loading reviews:', error);
            reviewsContainer.innerHTML = '<div class="text-center py-4"><div class="text-muted"><i class="fab fa-google fa-2x mb-3"></i><p>Unable to load Google reviews at this time.</p><small>Please try again later.</small></div></div>';
        });
}

function toggleReviewText(element, event) {
    event.preventDefault();
    const shortText = element.parentElement.querySelector('.review-text-short');
    const fullText = element.parentElement.querySelector('.review-text-full');
    
    if (shortText.style.display === 'none') {
        shortText.style.display = 'inline';
        fullText.style.display = 'none';
        element.textContent = 'Read more';
    } else {
        shortText.style.display = 'none';
        fullText.style.display = 'inline';
        element.textContent = 'Read less';
    }
}

// Initialize reviews loading
console.log('CLINIC PROFILE: Setting up review initialization...');

function initializeReviews() {
    console.log('CLINIC PROFILE: Initializing reviews...');
    loadGoogleReviews();
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('CLINIC PROFILE: DOM loaded, starting reviews...');
    setTimeout(initializeReviews, 1000);
});

// Fallback for already loaded document
if (document.readyState === 'complete' || document.readyState === 'interactive') {
    console.log('CLINIC PROFILE: Document already loaded, starting reviews immediately...');
    setTimeout(initializeReviews, 500);
}

// Map functionality with server-side geocoding
function loadMap() {
    const clinicAddress = "{{ clinic.address or (clinic.name + ', ' + (clinic.city or 'Location not available')) }}";
    const clinicName = "{{ clinic.name }}";
    
    console.log('Loading map with address:', clinicAddress);
    
    // Use server-side geocoding endpoint to avoid CORS issues
    fetch('/geocode', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
        },
        body: JSON.stringify({
            address: clinicAddress
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const lat = data.latitude;
            const lng = data.longitude;
            
            console.log('Geocoded coordinates:', lat, lng);
            
            // Hide loading spinner
            const loadingElement = document.getElementById('map-loading');
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
            
            // Initialize the map
            const map = L.map('map').setView([lat, lng], 15);
            
            // Add CartoDB tiles with English labels
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors ¬© <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);
            
            // Create custom clinic icon
            const clinicIcon = L.divIcon({
                html: '<i class="fas fa-map-marker-alt" style="color: #4A90E2; font-size: 30px;"></i>',
                iconSize: [30, 30],
                className: 'custom-div-icon'
            });
            
            // Add marker for clinic
            L.marker([lat, lng], { icon: clinicIcon }).addTo(map)
                .bindPopup(`
                    <div class="text-center p-2">
                        <strong style="color: #4A90E2;">${clinicName}</strong><br>
                        <small class="text-muted">${clinicAddress}</small><br>
                        <button class="btn btn-primary btn-sm mt-2" onclick="openDirections()">
                            <i class="fas fa-directions"></i> Get Directions
                        </button>
                    </div>
                `)
                .openPopup();
                
            // Add clinic service area circle
            L.circle([lat, lng], {
                color: '#4A90E2',
                fillColor: '#4A90E2',
                fillOpacity: 0.1,
                radius: 1000,
                weight: 2
            }).addTo(map);
            
            // Show directions button
            const directionsBtn = document.getElementById('directions-btn');
            if (directionsBtn) {
                directionsBtn.style.display = 'inline-block';
                directionsBtn.setAttribute('data-lat', lat);
                directionsBtn.setAttribute('data-lng', lng);
            }
            
            console.log('Map loaded successfully with geocoded coordinates');
        } else {
            throw new Error(data.error || 'Geocoding failed');
        }
    })
    .catch(error => {
        console.error('Error loading map:', error);
        document.getElementById('map').innerHTML = `
            <div class="d-flex align-items-center justify-content-center h-100">
                <div class="text-center">
                    <i class="fas fa-map-marker-alt fa-3x text-muted mb-3"></i>
                    <p class="text-muted mb-2">${clinicName}</p>
                    <p class="small text-muted mb-3">${clinicAddress}</p>
                    <p class="small text-warning">Map temporarily unavailable</p>
                    <button class="btn btn-primary btn-sm" onclick="openAddressInMaps()">
                        <i class="fas fa-external-link-alt"></i> Open in Maps
                    </button>
                </div>
            </div>
        `;
    });
}

// Open directions function
function openDirections() {
    const directionsBtn = document.getElementById('directions-btn');
    if (directionsBtn && directionsBtn.hasAttribute('data-lat') && directionsBtn.hasAttribute('data-lng')) {
        const lat = directionsBtn.getAttribute('data-lat');
        const lng = directionsBtn.getAttribute('data-lng');
        const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
        window.open(url, '_blank');
    } else {
        openAddressInMaps();
    }
}

// Fallback function to open address in external maps
function openAddressInMaps() {
    const address = "{{ clinic.area or clinic.address }}, {{ clinic.city }}, {{ clinic.state }}";
    const encodedAddress = encodeURIComponent(address);
    const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodedAddress}`;
    window.open(googleMapsUrl, '_blank');
}

// Ensure this function takes priority over any modal handlers
window.instantContactClinic = async function(clinicId, contactType) {
    console.log('Clinic instant contact called:', clinicId, contactType);
    const btn = contactType === 'whatsapp' ? document.getElementById('clinic-whatsapp-btn') : document.getElementById('clinic-call-btn');
    const btnText = btn.querySelector('.btn-text');
    const originalText = btnText.textContent;
    
    // Show loading state
    btnText.textContent = 'Connecting...';
    btn.disabled = true;
    
    try {
        const response = await fetch(`/instant-contact/clinic/${clinicId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
            },
            body: JSON.stringify({
                contact_type: contactType
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Success! Open contact immediately
            if (contactType === 'whatsapp') {
                window.open(data.whatsapp_url, '_blank');
                
                // Show success feedback
                btnText.textContent = '‚úì Connected';
                setTimeout(() => {
                    btnText.textContent = originalText;
                }, 2000);
                
                // Optional: Show toast notification
                showToast('Connecting to clinic WhatsApp...', 'success');
                
            } else if (contactType === 'call') {
                // Open phone dialer without navigating away from page
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = data.tel_url;
                document.body.appendChild(iframe);
                setTimeout(() => document.body.removeChild(iframe), 1000);
                
                // Show success feedback
                btnText.textContent = '‚úì Calling';
                setTimeout(() => {
                    btnText.textContent = originalText;
                }, 2000);
                
                // Optional: Show toast notification
                showToast('Calling clinic...', 'success');
            }
            
        } else if (data.requires_auth) {
            // User needs to authenticate
            if (confirm('Please sign in to get clinic contact details. Would you like to sign in now?')) {
                window.location.href = data.redirect_url;
            }
            
        } else {
            // Other error
            alert(data.message || 'Unable to connect. Please try again.');
        }
        
    } catch (error) {
        console.error('Error:', error);
        alert('Connection error. Please try again.');
    } finally {
        // Reset button state
        btnText.textContent = originalText;
        btn.disabled = false;
    }
}

// Simple toast notification function
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : 'info'} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
            ${message}
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // Remove after 3 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 3000);
};  // End of instantContactClinic function

// Initialize map loading
document.addEventListener('DOMContentLoaded', function() {
    // Auto-load map using address-based geocoding
    // Wait for Leaflet to be fully loaded
    if (typeof L !== 'undefined') {
        loadMap();
    } else {
        // Wait a bit for Leaflet to load
        setTimeout(function() {
            if (typeof L !== 'undefined') {
                loadMap();
            } else {
                console.error('Leaflet library not loaded');
                // Show fallback if Leaflet fails to load
                document.getElementById('map').innerHTML = `
                    <div class="d-flex align-items-center justify-content-center h-100">
                        <div class="text-center">
                            <i class="fas fa-map-marker-alt fa-3x text-muted mb-3"></i>
                            <p class="text-muted mb-2">{{ clinic.name }}</p>
                            <p class="small text-muted mb-3">{{ clinic.address or (clinic.name + ', ' + (clinic.city or 'Location not available')) }}</p>
                            <button class="btn btn-primary btn-sm" onclick="openAddressInMaps()">
                                <i class="fas fa-external-link-alt"></i> Open in Maps
                            </button>
                        </div>
                    </div>
                `;
            }
        }, 500);
    }
});
</script>
{% endblock %}