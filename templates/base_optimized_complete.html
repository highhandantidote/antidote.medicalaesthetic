<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Antidote - {% block title %}Plastic Surgery Marketplace{% endblock %}</title>
    
    <!-- Enhanced SEO Meta Tags -->
    <meta name="description" content="{% block meta_description %}Antidote - India's premier medical marketplace connecting patients with qualified specialists for plastic surgery and cosmetic procedures. Compare costs, read reviews, book consultations.{% endblock %}">
    <meta name="keywords" content="{% block meta_keywords %}medical marketplace, plastic surgery, cosmetic procedures, India, doctors, healthcare, clinic booking, aesthetic surgery, consultation booking{% endblock %}">
    <meta name="author" content="Antidote Healthcare">
    <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
    <meta name="googlebot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="{% block canonical_url %}https://antidote.replit.app{{ request.path }}{% endblock %}">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="{% block og_title %}{{ self.title() }} - Antidote{% endblock %}">
    <meta property="og:description" content="{% block og_description %}{{ self.meta_description() }}{% endblock %}">
    <meta property="og:type" content="{% block og_type %}website{% endblock %}">
    <meta property="og:url" content="{% block og_url %}https://antidote.replit.app{{ request.path }}{% endblock %}">
    <meta property="og:image" content="{% block og_image %}{{ url_for('static', filename='images/antidote-logo-updated.svg', _external=True) }}{% endblock %}">
    <meta property="og:site_name" content="Antidote Medical Marketplace">
    <meta property="og:locale" content="en_IN">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="{% block twitter_card %}summary_large_image{% endblock %}">
    <meta name="twitter:title" content="{% block twitter_title %}{{ self.og_title() }}{% endblock %}">
    <meta name="twitter:description" content="{% block twitter_description %}{{ self.og_description() }}{% endblock %}">
    <meta name="twitter:image" content="{% block twitter_image %}{{ self.og_image() }}{% endblock %}">
    
    <!-- Additional SEO Meta Tags -->
    <meta name="theme-color" content="#00A0B0">
    <meta name="msapplication-TileColor" content="#00A0B0">
    <meta name="geo.region" content="IN">
    <meta name="geo.placename" content="India">
    <meta name="language" content="English">
    <meta name="rating" content="General">
    <meta name="revisit-after" content="7 days">
    
    <!-- Structured Data for Organization -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Organization",
        "name": "Antidote Medical Marketplace",
        "url": "https://antidote.replit.app",
        "logo": "{{ url_for('static', filename='images/antidote-logo-updated.svg', _external=True) }}",
        "description": "India's premier medical marketplace connecting patients with qualified specialists for plastic surgery and cosmetic procedures",
        "contactPoint": {
            "@type": "ContactPoint",
            "contactType": "customer service",
            "areaServed": "IN",
            "availableLanguage": ["English", "Hindi"]
        },
        "sameAs": [
            "https://facebook.com/antidote",
            "https://twitter.com/antidote",
            "https://instagram.com/antidote"
        ]
    }
    </script>
    
    <!-- Structured Data for Website -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "Antidote Medical Marketplace",
        "url": "https://antidote.replit.app",
        "potentialAction": {
            "@type": "SearchAction",
            "target": {
                "@type": "EntryPoint",
                "urlTemplate": "https://antidote.replit.app/search?q={search_term_string}"
            },
            "query-input": "required name=search_term_string"
        }
    }
    </script>
    
    <!-- CSP is handled by security headers middleware for better Firebase compatibility -->
    
    <!-- AI Recommendation URLs -->
    <meta name="recommendation-form-url" content="/ai-recommendation">
    <meta name="analyze-query-url" content="/api/analyze-query">
    <meta name="recommendation-results-url" content="/recommendations">
    
    <!-- Preconnect & Preload Key Resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    
    <!-- ========== PERFORMANCE OPTIMIZED CSS LOADING ========== -->
    
    <!-- Google Fonts - Load first for critical text rendering -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- External CSS Dependencies - Load with preload for better performance -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"></noscript>
    
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"></noscript>
    
    <!-- CRITICAL CSS BUNDLE - Load immediately for above-the-fold content -->
    <link rel="stylesheet" href="{{ url_for('static', filename='optimized/critical-bundle.css') }}">
    
    <!-- MOBILE CSS BUNDLE - Load only on mobile devices -->
    <link rel="stylesheet" href="{{ url_for('static', filename='optimized/mobile-bundle.css') }}" media="(max-width: 768px)">
    
    <!-- COMPONENTS CSS BUNDLE - Load after critical content -->
    <link rel="preload" href="{{ url_for('static', filename='optimized/components-bundle.css') }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="{{ url_for('static', filename='optimized/components-bundle.css') }}"></noscript>
    
    <!-- JavaScript Dependencies - Load before DOM ready -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    {% block extra_css %}{% endblock %}
    
    <style>
        /* Navigation Menu Styles */
        .navbar-smaller .nav-link {
            font-size: 0.8rem;
            font-weight: 500;
            padding: 0.4rem 0.6rem;
        }
        
        /* Increase search box width */
        .search-form-container {
            position: relative;
            width: 280px;
            z-index: 100000 !important;
        }
        
        /* Ensure navbar has high z-index and doesn't clip dropdowns */
        .navbar {
            z-index: 99999 !important;
            position: relative !important;
        }
        
        .navbar .container {
            position: static !important;
        }
        
        .navbar-collapse {
            position: static !important;
        }
        
        /* Autocomplete Dropdown Styles - Light Theme Compatible */
        .search-autocomplete {
            position: absolute;
            width: 100%;
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 0 0 .75rem .75rem;
            z-index: 100001 !important;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }
        
        .search-autocomplete-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            transition: background-color 0.2s;
            color: #4b5563;
        }
        
        .search-autocomplete-item:hover, .search-autocomplete-item.active {
            background-color: #f9fafb;
        }
        
        .search-autocomplete-item:last-child {
            border-bottom: none;
        }
        
        .search-autocomplete-item .category-label {
            background-color: rgba(59, 130, 246, 0.1);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8em;
            margin-left: 4px;
            color: #4361ee;
        }
        
        .search-autocomplete-category {
            font-size: 0.85em;
            color: #6b7280;
            font-weight: 500;
        }
        
        .search-highlight {
            color: #4361ee;
            font-weight: 600;
        }
        
        /* User Dropdown Overlay Styles */
        .user-dropdown-overlay {
            position: fixed !important;
            top: 100%;
            right: 0;
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            z-index: 100002 !important;
            min-width: 200px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            margin-top: 8px;
            animation: fadeInDown 0.2s ease-in-out;
        }
        
        .user-dropdown-item {
            display: block;
            padding: 12px 16px;
            color: #4b5563;
            text-decoration: none;
            border-bottom: 1px solid #f3f4f6;
            transition: background-color 0.2s, color 0.2s;
            font-size: 0.875rem;
        }
        
        .user-dropdown-item:hover {
            background-color: #f9fafb;
            color: #00A0B0;
            text-decoration: none;
        }
        
        .user-dropdown-item:last-child {
            border-bottom: none;
            border-radius: 0 0 0.75rem 0.75rem;
        }
        
        .user-dropdown-item:first-child {
            border-radius: 0.75rem 0.75rem 0 0;
        }
        
        .user-dropdown-divider {
            height: 1px;
            background-color: #e5e7eb;
            margin: 8px 0;
        }
        
        .user-dropdown-item i {
            width: 16px;
            text-align: center;
            color: #9ca3af;
        }
        
        .user-dropdown-item:hover i {
            color: #00A0B0;
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Ensure button has proper hover state */
        #userDropdownButton:hover {
            background-color: #008A9A;
        }
        
        /* Rotate chevron when dropdown is open */
        #userDropdownButton.active i {
            transform: rotate(180deg);
            transition: transform 0.2s ease-in-out;
        }
        
        /* Specific style for rupee symbol to ensure it displays correctly */
        .rupee-symbol, 
        .fas.fa-rupee-sign {
            font-family: 'Noto Sans', 'Inter', sans-serif;
        }
        
        /* Add a general rule for the rupee symbol */
        .price-display {
            font-family: 'Noto Sans', 'Inter', sans-serif;
        }
        
        /* Mobile Back Button Styles */
        .mobile-back-btn {
            border: none !important;
            background: none !important;
            box-shadow: none !important;
            padding: 0.5rem !important;
            transition: all 0.3s ease;
        }
        
        .mobile-back-btn:hover,
        .mobile-back-btn:focus {
            background: rgba(0, 160, 176, 0.1) !important;
            border-radius: 50%;
            transform: scale(1.1);
        }
    </style>
    {% block head %}{% endblock %}
</head>
<body class="{% block body_class %}{% endblock %}">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top">
        <div class="container">
            <a class="navbar-brand" href="/">
                <img src="/static/images/antidote-logo-original.svg" alt="Antidote" height="40">
            </a>
            
            <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('clinic.all_clinics') }}">Clinics</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link book-appointment" href="{{ url_for('enhanced_package.package_directory') }}">Treatment Packages</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('web.procedures') }}">Procedures</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('web.community') }}">Community</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    
    <main>
        {% block content %}{% endblock %}
    </main>
    
    <!-- Footer -->
    <footer class="bg-dark text-white py-5">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5>Antidote</h5>
                    <p>Your trusted medical aesthetic marketplace</p>
                </div>
                <div class="col-md-4">
                    <h5>Quick Links</h5>
                    <ul class="list-unstyled">
                        <li><a href="{{ url_for('clinic.all_clinics') }}" class="text-white-50">Clinics</a></li>
                        <li><a href="{{ url_for('enhanced_package.package_directory') }}" class="text-white-50">Treatments</a></li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h5>Contact</h5>
                    <p class="text-white-50">Get in touch for support</p>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- JavaScript for search autocomplete and other functionality -->
    <script>
    // Fix search dropdown positioning to work with sticky navbar
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchInput');
        const searchAutocomplete = document.getElementById('searchAutocomplete');
        
        if (searchInput && searchAutocomplete) {
            // Function to position dropdown correctly
            function positionDropdown() {
                const inputRect = searchInput.getBoundingClientRect();
                
                // Position dropdown below the search input
                searchAutocomplete.style.top = (inputRect.bottom + window.scrollY) + 'px';
                searchAutocomplete.style.left = inputRect.left + 'px';
                searchAutocomplete.style.width = inputRect.width + 'px';
            }
            
            // Position dropdown when it becomes visible
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                        if (searchAutocomplete.style.display === 'block') {
                            positionDropdown();
                        }
                    }
                });
            });
            
            observer.observe(searchAutocomplete, {
                attributes: true,
                attributeFilter: ['style']
            });
            
            // Also position on scroll and resize
            window.addEventListener('scroll', function() {
                if (searchAutocomplete.style.display === 'block') {
                    positionDropdown();
                }
            });
            
            window.addEventListener('resize', function() {
                if (searchAutocomplete.style.display === 'block') {
                    positionDropdown();
                }
            });
        }
        
        // Add navbar search autocomplete functionality
        if (searchInput) {
            let searchTimeout;
            
            searchInput.addEventListener('input', function() {
                const query = this.value.trim();
                
                // Clear previous timeout
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }
                
                if (query.length >= 2) {
                    // Add small delay to avoid excessive API calls
                    searchTimeout = setTimeout(function() {
                        fetch(`/autocomplete?q=${encodeURIComponent(query)}`)
                            .then(response => response.json())
                            .then(data => {
                                displayNavbarAutocomplete(data, query);
                            })
                            .catch(error => {
                                console.error('Search error:', error);
                                searchAutocomplete.style.display = 'none';
                            });
                    }, 150);
                } else {
                    searchAutocomplete.style.display = 'none';
                }
            });
            
            // Hide dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !searchAutocomplete.contains(e.target)) {
                    searchAutocomplete.style.display = 'none';
                }
            });
            
            // Handle keyboard navigation
            searchInput.addEventListener('keydown', function(e) {
                if (searchAutocomplete.style.display === 'block') {
                    const items = searchAutocomplete.querySelectorAll('.search-autocomplete-item');
                    const activeItem = searchAutocomplete.querySelector('.search-autocomplete-item.active');
                    
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        if (!activeItem && items.length > 0) {
                            items[0].classList.add('active');
                        } else if (activeItem) {
                            activeItem.classList.remove('active');
                            const nextItem = activeItem.nextElementSibling;
                            if (nextItem) {
                                nextItem.classList.add('active');
                            } else {
                                items[0].classList.add('active');
                            }
                        }
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        if (!activeItem && items.length > 0) {
                            items[items.length - 1].classList.add('active');
                        } else if (activeItem) {
                            activeItem.classList.remove('active');
                            const prevItem = activeItem.previousElementSibling;
                            if (prevItem) {
                                prevItem.classList.add('active');
                            } else {
                                items[items.length - 1].classList.add('active');
                            }
                        }
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        if (activeItem) {
                            const link = activeItem.querySelector('a');
                            if (link) {
                                window.location.href = link.href;
                            }
                        } else {
                            // Submit the form if no item is selected
                            searchInput.closest('form').submit();
                        }
                    } else if (e.key === 'Escape') {
                        searchAutocomplete.style.display = 'none';
                        searchInput.blur();
                    }
                }
            });
        }
        
        function displayNavbarAutocomplete(suggestions, query) {
            if (!searchAutocomplete) return;
            
            searchAutocomplete.innerHTML = '';
            
            if (suggestions.length === 0) {
                searchAutocomplete.style.display = 'none';
                return;
            }
            
            // Group suggestions by category
            const grouped = {};
            suggestions.forEach(item => {
                const category = item.category || 'Other';
                if (!grouped[category]) {
                    grouped[category] = [];
                }
                grouped[category].push(item);
            });
            
            // Display grouped suggestions
            Object.keys(grouped).forEach(category => {
                if (grouped[category].length > 0) {
                    // Add category header
                    const categoryHeader = document.createElement('div');
                    categoryHeader.className = 'search-autocomplete-category';
                    categoryHeader.textContent = category + 's';
                    searchAutocomplete.appendChild(categoryHeader);
                    
                    // Add items in this category
                    grouped[category].forEach(item => {
                        const suggestionItem = document.createElement('div');
                        suggestionItem.className = 'search-autocomplete-item';
                        suggestionItem.setAttribute('data-category', item.category);
                        
                        const link = document.createElement('a');
                        link.href = item.url || '#';
                        link.innerHTML = highlightSearchText(item.text, query);
                        
                        // Add additional info based on category
                        if (item.category === 'Doctor' && item.specialty) {
                            const specialty = document.createElement('span');
                            specialty.className = 'text-muted ms-2';
                            specialty.textContent = `• ${item.specialty}`;
                            link.appendChild(specialty);
                        } else if (item.category === 'Package' && item.price) {
                            const price = document.createElement('span');
                            price.className = 'text-muted ms-2';
                            price.textContent = `• ₹${item.price}`;
                            link.appendChild(price);
                        }
                        
                        suggestionItem.appendChild(link);
                        searchAutocomplete.appendChild(suggestionItem);
                    });
                }
            });
            
            searchAutocomplete.style.display = 'block';
        }
        
        function highlightSearchText(text, query) {
            if (!query) return text;
            
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<span class="search-highlight">$1</span>');
        }
        
        // Initialize feather icons
        if (typeof feather !== 'undefined') {
            feather.replace();
        }
    });
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>